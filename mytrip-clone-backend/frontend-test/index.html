<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MyTrip API Tester - Modern UI</title>
    <style>
        :root {
          --primary: #2563eb;
          --primary-light: #dbeafe;
          --bg: #0f172a;
          --card-bg: #020617;
          --border: #1e293b;
          --text: #e5e7eb;
          --muted: #9ca3af;
          --danger: #ef4444;
          --success: #22c55e;
        }

        * {
          box-sizing: border-box;
        }

        body {
          margin: 0;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          background: radial-gradient(circle at top, #1e293b, #020617);
          color: var(--text);
          min-height: 100vh;
          display: flex;
          flex-direction: column;
        }

        h1, h2, h3 {
          margin: 0 0 8px;
        }

        .app {
          max-width: 1200px;
          margin: 20px auto;
          padding: 16px;
        }

        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .logo {
          font-size: 24px;
          font-weight: 700;
          letter-spacing: 0.04em;
        }

        .badge {
          font-size: 12px;
          padding: 2px 8px;
          border-radius: 999px;
          background: rgba(148, 163, 184, 0.15);
          border: 1px solid rgba(148, 163, 184, 0.4);
          color: var(--muted);
        }

        .grid {
          display: grid;
          grid-template-columns: 340px 1fr;
          gap: 16px;
          align-items: flex-start;
        }

        .card {
          background: rgba(15, 23, 42, 0.95);
          border-radius: 14px;
          border: 1px solid var(--border);
          padding: 14px 16px;
          box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
          backdrop-filter: blur(16px);
        }

        .card + .card {
          margin-top: 10px;
        }

        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }

        .card-title {
          font-size: 15px;
          font-weight: 600;
        }

        .card-subtitle {
          font-size: 12px;
          color: var(--muted);
        }

        label {
          font-size: 12px;
          color: var(--muted);
          display: block;
          margin-bottom: 4px;
        }

        input, textarea, select {
          width: 100%;
          border-radius: 8px;
          border: 1px solid #1f2933;
          background: #020617;
          color: var(--text);
          padding: 7px 9px;
          font-size: 13px;
          margin-bottom: 8px;
          outline: none;
        }

        input:focus,
        textarea:focus,
        select:focus {
          border-color: var(--primary);
          box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        }

        textarea {
          resize: vertical;
          min-height: 80px;
        }

        button {
          border: none;
          border-radius: 999px;
          padding: 8px 14px;
          background: var(--primary);
          color: white;
          font-weight: 500;
          font-size: 13px;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          margin-top: 4px;
        }

        button.secondary {
          background: rgba(148, 163, 184, 0.2);
          color: var(--text);
        }

        button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .small-text {
          font-size: 11px;
          color: var(--muted);
        }

        .pill {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          font-size: 11px;
          padding: 3px 8px;
          border-radius: 999px;
          background: rgba(37, 99, 235, 0.12);
          border: 1px solid rgba(37, 99, 235, 0.35);
          color: #bfdbfe;
        }

        .muted-pill {
          background: rgba(15, 23, 42, 0.8);
          border-color: #334155;
          color: var(--muted);
        }

        .hotel-list, .room-list {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
          gap: 8px;
        }

        .hotel-card, .room-card {
          border-radius: 12px;
          border: 1px solid #1f2937;
          padding: 10px;
          background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), rgba(15, 23, 42, 0.96));
          cursor: pointer;
          transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        }

        .room-card {
          background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.16), rgba(15, 23, 42, 0.96));
        }

        .hotel-card:hover,
        .room-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
          border-color: var(--primary);
        }

        .hotel-card.selected,
        .room-card.selected {
          border-color: #22c55e;
          box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
        }

        .hotel-name {
          font-size: 14px;
          font-weight: 600;
          margin-bottom: 4px;
        }

        .hotel-meta {
          font-size: 12px;
          color: var(--muted);
          margin-bottom: 4px;
        }

        .hotel-price {
          font-size: 13px;
          font-weight: 500;
          color: #bbf7d0;
        }

        .status-bar {
          display: flex;
          justify-content: space-between;
          font-size: 11px;
          color: var(--muted);
          margin-top: 4px;
        }

        .output-card pre {
          background: #020617;
          border-radius: 10px;
          padding: 12px;
          font-size: 12px;
          max-height: 420px;
          overflow: auto;
        }

        .toast {
          position: fixed;
          right: 18px;
          bottom: 18px;
          background: rgba(15, 23, 42, 0.98);
          border-radius: 999px;
          padding: 8px 12px;
          border: 1px solid rgba(148, 163, 184, 0.5);
          font-size: 12px;
          display: none;
          align-items: center;
          gap: 8px;
          z-index: 50;
        }

        .toast.show {
          display: inline-flex;
          animation: fadeIn 0.18s ease-out;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(4px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .loader-backdrop {
          position: fixed;
          inset: 0;
          background: rgba(15, 23, 42, 0.5);
          backdrop-filter: blur(2px);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 40;
        }

        .loader-backdrop.show {
          display: flex;
        }

        .loader {
          width: 38px;
          height: 38px;
          border-radius: 999px;
          border: 3px solid rgba(148, 163, 184, 0.4);
          border-top-color: var(--primary);
          animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        .tag-row {
          display: flex;
          gap: 6px;
          flex-wrap: wrap;
          margin-top: 4px;
        }

        .row {
          display: flex;
          gap: 6px;
        }

        .row > div {
          flex: 1;
        }

        @media (max-width: 900px) {
          .grid {
            grid-template-columns: 1fr;
          }
        }
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <div>
            <div class="logo">MyTrip API Studio</div>
            <div class="small-text">Test your Spring Boot backend without Postman – direct from browser.</div>
        </div>
        <div>
            <span class="badge" id="authStatus">Not logged in</span>
        </div>
    </div>

    <div class="grid">
        <!-- LEFT COLUMN -->
        <div>
            <!-- AUTH -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Authentication</div>
                        <div class="card-subtitle">Signup & Login to get JWT token.</div>
                    </div>
                    <span class="pill muted-pill">Step 1</span>
                </div>

                <label>Signup</label>
                <input id="su_user" placeholder="Username" />
                <input id="su_email" placeholder="Email" />
                <input id="su_pass" type="password" placeholder="Password" />
                <button onclick="signup()">Create account</button>

                <div style="height:10px"></div>

                <label>Login</label>
                <input id="lo_user" placeholder="Username or Email" />
                <input id="lo_pass" type="password" placeholder="Password" />
                <button onclick="login()">Login & save token</button>
                <div class="small-text" id="tokenPreview"></div>
            </div>

            <!-- HOTEL SEARCH -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Hotel Search</div>
                        <div class="card-subtitle">Public GET/POST – filter hotels.</div>
                    </div>
                    <span class="pill">Hotels</span>
                </div>

                <div class="row">
                    <div>
                        <label>City</label>
                        <input id="hotel_city" placeholder="Indore" />
                    </div>
                    <div>
                        <label>Guests</label>
                        <input id="hotel_guests" placeholder="2" />
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label>Check-in</label>
                        <input id="hotel_in" placeholder="YYYY-MM-DD" />
                    </div>
                    <div>
                        <label>Check-out</label>
                        <input id="hotel_out" placeholder="YYYY-MM-DD" />
                    </div>
                </div>
                <button onclick="searchHotels()">Search hotels</button>
                <div class="small-text">Search result hotels will appear on the right → select one to load rooms.</div>
            </div>

            <!-- ROOM & BOOKING -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Booking</div>
                        <div class="card-subtitle">Book selected room as logged-in user.</div>
                    </div>
                    <span class="pill">Bookings</span>
                </div>

                <div class="small-text">
                    Selected hotel ID: <span id="selectedHotelLabel">–</span><br />
                    Selected room ID: <span id="selectedRoomLabel">–</span>
                </div>

                <div style="height:8px"></div>

                <div class="row">
                    <div>
                        <label>Check-in</label>
                        <input id="b_in" placeholder="YYYY-MM-DD" />
                    </div>
                    <div>
                        <label>Check-out</label>
                        <input id="b_out" placeholder="YYYY-MM-DD" />
                    </div>
                </div>
                <label>Guests</label>
                <input id="b_guests" placeholder="2" />
                <button onclick="loadRooms()">Load rooms of selected hotel</button>
                <button onclick="createBooking()">Book selected room</button>
                <button class="secondary" onclick="myBookings()">My bookings</button>
            </div>

            <!-- FLIGHT / WISHLIST / REVIEW SHORT -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Quick Actions</div>
                    <span class="pill muted-pill">Extra</span>
                </div>

                <label>Flight Search</label>
                <div class="row">
                    <div><input id="f_from" placeholder="Origin ID" /></div>
                    <div><input id="f_to" placeholder="Destination ID" /></div>
                </div>
                <input id="f_date" placeholder="Date (YYYY-MM-DD)" />
                <button onclick="searchFlights()">Search flights</button>

                <div style="height:8px"></div>
                <label>Wishlist (HOTEL only)</label>
                <div class="row">
                    <div><input id="w_id" placeholder="Hotel ID" /></div>
                </div>
                <button onclick="addWishlist()">Add to wishlist</button>
                <button class="secondary" onclick="getWishlist()">Get wishlist</button>

                <div style="height:8px"></div>
                <label>Add Review for Hotel</label>
                <input id="r_id" placeholder="Hotel ID" />
                <input id="r_rate" placeholder="Rating (1-5)" />
                <textarea id="r_comment" placeholder="Your review..."></textarea>
                <button onclick="addReview()">Submit review</button>
            </div>

            <!-- UNIVERSAL -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Universal API Tester</div>
                    <span class="pill muted-pill">Advanced</span>
                </div>
                <label>Path (relative)</label>
                <input id="api_url" placeholder="/api/users/me" />
                <div class="row">
                    <div>
                        <label>Method</label>
                        <select id="api_method">
                            <option>GET</option>
                            <option>POST</option>
                        </select>
                    </div>
                    <div>
                        <label>Body (JSON)</label>
                    </div>
                </div>
                <textarea id="api_body" placeholder='{"example": "value"} (leave empty for GET)'></textarea>
                <button onclick="callApi()">Send request</button>
                <div class="small-text">Authorization header automatically attaches current JWT if available.</div>
            </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div>
            <!-- HOTELS / ROOMS -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Hotels & Rooms</div>
                        <div class="card-subtitle">Search results & room list for quick selection.</div>
                    </div>
                    <span class="pill">Live data</span>
                </div>

                <h3 style="font-size:13px;margin-top:0;">Hotels</h3>
                <div id="hotelList" class="hotel-list small-text">
                    <div class="small-text">Run a search from the left to see hotels here.</div>
                </div>

                <h3 style="font-size:13px;margin-top:12px;">Rooms of selected hotel</h3>
                <div id="roomList" class="room-list small-text">
                    <div class="small-text">Click "Load rooms" after selecting a hotel.</div>
                </div>
            </div>

            <!-- OUTPUT -->
            <div class="card output-card" style="margin-top:10px;">
                <div class="card-header">
                    <div>
                        <div class="card-title">API Response</div>
                        <div class="card-subtitle">Raw response (JSON or text) of last call.</div>
                    </div>
                    <span class="pill muted-pill" id="lastEndpointLabel">No request yet</span>
                </div>
                <pre id="res">Waiting for request…</pre>
            </div>
        </div>
    </div>
</div>

<!-- Loader -->
<div class="loader-backdrop" id="loader">
    <div class="loader"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
    <span id="toastText"></span>
</div>

<script>
    const API_BASE = "http://localhost:8080";
    let token = "";
    let lastHotels = [];
    let lastRooms = [];
    let selectedHotelId = null;
    let selectedRoomId = null;

    const loaderEl = document.getElementById("loader");
    const toastEl = document.getElementById("toast");
    const toastText = document.getElementById("toastText");
    const resEl = document.getElementById("res");
    const lastEndpointLabel = document.getElementById("lastEndpointLabel");
    const authStatus = document.getElementById("authStatus");
    const tokenPreview = document.getElementById("tokenPreview");
    const hotelList = document.getElementById("hotelList");
    const roomList = document.getElementById("roomList");
    const selectedHotelLabel = document.getElementById("selectedHotelLabel");
    const selectedRoomLabel = document.getElementById("selectedRoomLabel");

    function setLoading(isLoading) {
      loaderEl.classList.toggle("show", isLoading);
    }

    function showToast(message) {
      toastText.textContent = message;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2500);
    }

    async function api(path, options = {}) {
      const url = API_BASE + path;
      lastEndpointLabel.textContent = path;
      setLoading(true);
      try {
        const headers = options.headers || {};
        headers["Content-Type"] = headers["Content-Type"] || "application/json";
        if (token) {
          headers["Authorization"] = "Bearer " + token;
        }
        const resp = await fetch(url, {
          method: options.method || "GET",
          headers,
          body: options.body || null
        });
        const text = await resp.text();
        let data;
        try {
          data = JSON.parse(text);
          resEl.textContent = JSON.stringify(data, null, 2);
        } catch (_) {
          data = text;
          resEl.textContent = text;
        }
        if (!resp.ok) {
          showToast("Error: " + resp.status);
        }
        return data;
      } catch (err) {
        resEl.textContent = "ERROR: " + err;
        showToast("Network error");
        return null;
      } finally {
        setLoading(false);
      }
    }

    function updateAuthUI(username) {
      if (token) {
        authStatus.textContent = "Logged in as " + (username || "user");
        authStatus.style.background = "rgba(34,197,94,0.15)";
        authStatus.style.borderColor = "rgba(34,197,94,0.5)";
      } else {
        authStatus.textContent = "Not logged in";
        authStatus.style.background = "rgba(148, 163, 184, 0.15)";
        authStatus.style.borderColor = "rgba(148, 163, 184, 0.5)";
      }
    }

    // AUTH
    async function signup() {
      const body = {
        username: document.getElementById("su_user").value,
        email: document.getElementById("su_email").value,
        password: document.getElementById("su_pass").value
      };
      await api("/api/auth/signup", {
        method: "POST",
        body: JSON.stringify(body)
      });
      showToast("Signup attempted");
    }

    async function login() {
      const body = {
        usernameOrEmail: document.getElementById("lo_user").value,
        password: document.getElementById("lo_pass").value
      };
      const data = await api("/api/auth/login", {
        method: "POST",
        body: JSON.stringify(body)
      });
      if (data && data.token) {
        token = data.token;
        tokenPreview.textContent = "Token: " + data.token.substring(0, 30) + "...";
        updateAuthUI(data.username || body.usernameOrEmail);
        showToast("Login successful");
      } else {
        showToast("Login failed");
      }
    }

    // HOTELS
    async function searchHotels() {
      const body = {
        city: document.getElementById("hotel_city").value || null,
        checkInDate: document.getElementById("hotel_in").value || null,
        checkOutDate: document.getElementById("hotel_out").value || null,
        guests: parseInt(document.getElementById("hotel_guests").value || "1", 10)
      };
      const data = await api("/api/hotels/search", {
        method: "POST",
        body: JSON.stringify(body)
      });
      if (Array.isArray(data)) {
        lastHotels = data;
        renderHotels();
        showToast("Hotels loaded: " + data.length);
      }
    }

    function renderHotels() {
      hotelList.innerHTML = "";
      if (!lastHotels.length) {
        hotelList.innerHTML = "<div class='small-text'>No hotels found.</div>";
        return;
      }
      lastHotels.forEach(hotel => {
        const card = document.createElement("div");
        card.className = "hotel-card" + (hotel.id === selectedHotelId ? " selected" : "");
        card.onclick = () => selectHotel(hotel.id);

        const name = hotel.name || ("Hotel #" + hotel.id);
        const city = hotel.city || hotel.location || "Unknown city";
        const rating = hotel.rating != null ? hotel.rating : "–";
        const price = hotel.minPrice || hotel.pricePerNight || hotel.basePrice || null;

        card.innerHTML = `
          <div class="hotel-name">${name}</div>
          <div class="hotel-meta">${city}</div>
          <div class="tag-row">
            <span class="pill muted-pill">ID: ${hotel.id}</span>
            <span class="pill muted-pill">Rating: ${rating}</span>
          </div>
          <div class="status-bar">
            <div class="hotel-price">${price ? "From ₹" + price : "Price: N/A"}</div>
          </div>
        `;
        hotelList.appendChild(card);
      });
    }

    function selectHotel(id) {
      selectedHotelId = id;
      selectedRoomId = null;
      selectedHotelLabel.textContent = id;
      selectedRoomLabel.textContent = "–";
      renderHotels();
      roomList.innerHTML = "<div class='small-text'>Click \"Load rooms\" to fetch rooms for hotel " + id + ".</div>";
      showToast("Hotel selected: " + id);
    }

    async function loadRooms() {
      if (!selectedHotelId) {
        showToast("Select a hotel first");
        return;
      }
      const data = await api(`/api/hotels/${selectedHotelId}/rooms`, {
        method: "GET"
      });
      if (Array.isArray(data)) {
        lastRooms = data;
        renderRooms();
        showToast("Rooms loaded: " + data.length);
      }
    }

    function renderRooms() {
      roomList.innerHTML = "";
      if (!lastRooms.length) {
        roomList.innerHTML = "<div class='small-text'>No rooms found.</div>";
        return;
      }
      lastRooms.forEach(room => {
        const card = document.createElement("div");
        card.className = "room-card" + (room.id === selectedRoomId ? " selected" : "");
        card.onclick = () => selectRoom(room.id);

        const type = room.roomType || room.type || "Room";
        const price = room.pricePerNight || room.price || "N/A";
        const guests = room.maxGuests || room.capacity || "–";

        card.innerHTML = `
          <div class="hotel-name">${type}</div>
          <div class="hotel-meta">Room ID: ${room.id}</div>
          <div class="tag-row">
            <span class="pill muted-pill">Max guests: ${guests}</span>
          </div>
          <div class="status-bar">
            <div class="hotel-price">₹${price} / night</div>
          </div>
        `;
        roomList.appendChild(card);
      });
    }

    function selectRoom(id) {
      selectedRoomId = id;
      selectedRoomLabel.textContent = id;
      renderRooms();
      showToast("Room selected: " + id);
    }

    // BOOKING
    async function createBooking() {
      if (!token) {
        showToast("Login required");
        return;
      }
      if (!selectedHotelId || !selectedRoomId) {
        showToast("Select hotel & room first");
        return;
      }
      const body = {
        hotelId: selectedHotelId,
        roomId: selectedRoomId,
        checkInDate: document.getElementById("b_in").value,
        checkOutDate: document.getElementById("b_out").value,
        guests: parseInt(document.getElementById("b_guests").value || "1", 10),
        userId: 1 // backend can also infer from token, adjust if needed
      };
      await api("/api/bookings/create", {
        method: "POST",
        body: JSON.stringify(body)
      });
      showToast("Booking request sent");
    }

    async function myBookings() {
      if (!token) {
        showToast("Login required");
        return;
      }
      await api("/api/bookings/me");
    }

    // FLIGHT
    async function searchFlights() {
      const body = {
        originId: parseInt(document.getElementById("f_from").value || "1", 10),
        destinationId: parseInt(document.getElementById("f_to").value || "2", 10),
        date: document.getElementById("f_date").value || null
      };
      await api("/api/search/flights", {
        method: "POST",
        body: JSON.stringify(body)
      });
      showToast("Flight search sent");
    }

    // WISHLIST
    async function addWishlist() {
      if (!token) {
        showToast("Login required");
        return;
      }
      const hotelId = document.getElementById("w_id").value || selectedHotelId;
      if (!hotelId) {
        showToast("Provide hotel ID");
        return;
      }
      await api(`/api/wishlist/HOTEL/${hotelId}`, { method: "POST" });
      showToast("Wishlist add request sent");
    }

    async function getWishlist() {
      if (!token) {
        showToast("Login required");
        return;
      }
      await api("/api/wishlist");
    }

    // REVIEW
    async function addReview() {
      if (!token) {
        showToast("Login required");
        return;
      }
      const body = {
        targetType: "HOTEL",
        targetId: parseInt(document.getElementById("r_id").value || selectedHotelId || "0", 10),
        rating: parseInt(document.getElementById("r_rate").value || "5", 10),
        title: "Quick review",
        comment: document.getElementById("r_comment").value || "No comment"
      };
      await api("/api/reviews", {
        method: "POST",
        body: JSON.stringify(body)
      });
      showToast("Review submitted");
    }

    // UNIVERSAL TESTER
    async function callApi() {
      const path = document.getElementById("api_url").value || "/api/users/me";
      const method = document.getElementById("api_method").value;
      const bodyText = document.getElementById("api_body").value.trim();
      let body = null;
      if (method === "POST" && bodyText) {
        try {
          body = JSON.stringify(JSON.parse(bodyText));
        } catch (e) {
          showToast("Invalid JSON in body");
          return;
        }
      }
      await api(path, {
        method,
        body
      });
    }

    // Init
    updateAuthUI();
</script>
</body>
</html>
